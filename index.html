<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>بحث عن الهواتف</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      /* --- التنسيقات الأصلية (محفوظة) --- */
      body {
        background: #f7f8fb;
        font-family: Tahoma, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #222;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .search-modal-box { max-width: 720px; margin: 48px auto; background: #fff; border-radius: 16px; box-shadow: 0 6px 22px rgba(13,110,253,0.06); padding: 26px; }
      .search-field { width: 100%; padding: 12px 14px; border: 2px solid #e6e9ee; border-radius: 12px; font-size: 16px; transition: box-shadow .15s, border-color .15s; }
      .search-field:focus { outline: none; border-color: #bcd7ff; box-shadow: 0 6px 18px rgba(13,110,253,0.06); }
      #result { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
      .phone-card { background:#fff; border-radius:14px; border:1px solid rgba(12,28,55,0.04); box-shadow:0 6px 18px rgba(22,28,45,0.06); transition:.18s; cursor:pointer; overflow:hidden; }
      .phone-card:hover { transform:translateY(-6px); box-shadow:0 18px 40px rgba(13,110,253,0.08); }
      .phone-card img { width:100%; height:180px; object-fit:cover; display:block; background:linear-gradient(90deg,#f2f4f8,#eef2fb); }
      .phone-card .card-body { padding:12px; display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center; }
      .phone-title { font-weight:700; color:#0d6efd; font-size:15px; min-height:42px; display:flex; align-items:center; justify-content:center; }
      .chip-btn { width:100%; text-align:left; direction:ltr; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px; border-radius:8px; }
      .col-lg-custom { flex:0 0 20%; max-width:20%; }
      @media (max-width:1199px) { .col-lg-custom { flex:0 0 33.33%; max-width:33.33%; } }
      @media (max-width:767px) { .col-lg-custom { flex:0 0 48%; max-width:48%; } }
      @media (max-width:479px) { .col-lg-custom { flex:0 0 100%; max-width:100%; } }

      /* modal feature cards */
      .aps-feature-card { background:linear-gradient(180deg,#f8fbff 0%,#ffffff 100%); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(12,28,55,0.04); display:flex; flex-direction:column; align-items:center;}
      .aps-list-icon { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; margin-bottom:10px; color:#fff; }
      .aps-icon-mobile { background:#0d6efd; } .aps-icon-mobile::before { content:"📱"; }
      .aps-icon-cpu { background:#198754; } .aps-icon-cpu::before { content:"🧠"; }
      .aps-icon-camera { background:#fd7e14; } .aps-icon-camera::before { content:"📸"; }
      .aps-icon-hdd { background:#6f42c1; } .aps-icon-hdd::before { content:"💾"; }
      .aps-icon-code { background:#20c997; } .aps-icon-code::before { content:"⚙️"; }
      .aps-icon-battery { background:#ffc107; color:#000; } .aps-icon-battery::before { content:"🔋"; }

      /* tabs */
      .nav-tabs { overflow-x:auto; white-space:nowrap; flex-wrap:nowrap !important; }
      .nav-tabs .nav-link { font-weight:600; color:#0d6efd; border-radius:12px 12px 0 0; margin:2px; }
      .nav-tabs .nav-link.active { background:#0d6efd; color:#fff; }

      /* tooltip popup */
      .tooltip-popup { position:fixed; z-index:9999; padding:8px 12px; background:#333; color:#fff; border-radius:6px; font-size:13px; transition:opacity .18s; opacity:0; pointer-events:none; }
      .tooltip-popup.show { opacity:1; pointer-events:auto; }

      /* smooth modal */
      .modal.fade .modal-dialog { transition: transform .25s ease-out; transform:translateY(-12px); }
      .modal.show .modal-dialog { transform:translateY(0); }
    </style>
  </head>

  <body>
    <div class="container my-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="text-center mb-3 fw-bold text-primary">🔍 بحث عن الهواتف</h5>
          <form id="searchForm" class="text-center" onsubmit="return false;">
            <p class="message mb-3">اكتب كلمة البحث وسيبدأ البحث تلقائيًا...</p>
            <input type="search" class="search-field form-control mb-3 text-center" id="phoneInput" name="s" placeholder="ابحث عن اسم الهاتف..." autocomplete="off" />
            <div class="form-text text-muted small">البحث يبدأ تلقائيًا بعد التوقف 300ms — يتم استخدام التخزين المحلي لتسريع النتائج.</div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-body">
          <h5 class="text-center mb-4 text-primary fw-bold">📱 نتائج البحث</h5>
          <div id="result" class="row g-3 justify-content-start"></div>
        </div>
      </div>
    </div>

    <!-- modal specs -->
    <div class="modal fade" id="specsModal" tabindex="-1" aria-labelledby="specsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg rounded-4">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">تفاصيل الهاتف</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body" id="specsModalBody">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-3 text-muted">جاري التحميل...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- single tooltip container (reused) -->
    <div id="globalTooltip" class="tooltip-popup" style="display:none;"></div>

    <script>
      /*******************************
       * إعدادات البحث الفوري + Cache
       *******************************/
      const input = document.getElementById('phoneInput');
      const resultDiv = document.getElementById('result');
      const tooltipEl = document.getElementById('globalTooltip');

      // localStorage cache prefix + expiry (ms)
      const CACHE_PREFIX = 'phone_cache_v1_';
      const CACHE_TTL = 1000 * 60 * 60 * 6; // 6 ساعات

      // debounce + abort controller
      let typingTimer = null;
      let currentController = null;

      input.addEventListener('input', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(onSearchDebounced, 300);
      });

      // enter key also triggers but we already auto-search; prevent form submit refresh
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });

      function readCache(key) {
        try {
          const raw = localStorage.getItem(CACHE_PREFIX + key);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (Date.now() - parsed._ts > CACHE_TTL) { localStorage.removeItem(CACHE_PREFIX + key); return null; }
          return parsed.data;
        } catch (err) { return null; }
      }
      function writeCache(key, data) {
        try { localStorage.setItem(CACHE_PREFIX + key, JSON.stringify({ _ts: Date.now(), data })); } catch(e) {}
      }

      async function onSearchDebounced() {
        const q = input.value.trim();
        if (!q) {
          // نظف النتائج بدون وميض
          resultDiv.innerHTML = '';
          return;
        }
        const key = q.toLowerCase();

        // أولاً: عرض نتائج من الكاش بشكل فوري إن وُجدت
        const cached = readCache(key);
        if (cached) {
          renderResults(cached, { fromCache: true });
          // كما نتابع جلب نسخة محدثة في الخلفية (stale-while-revalidate)
          backgroundRefresh(key, q);
          return;
        }

        // لا كاش -> جلب فوري
        await fetchAndRender(key, q);
      }

      // background refresh: يجلب من السيرفر ويحدث الكاش لكن لا يغير العرض إذا المستخدم غيّر الاستعلام
      async function backgroundRefresh(cacheKey, query) {
        try {
          const res = await fetch(`/api/phone?phone=${encodeURIComponent(query)}`);
          if (!res.ok) return;
          const data = await res.json();
          if (data.results) {
            writeCache(cacheKey, data.results);
          }
        } catch (err) { /* silent */ }
      }

      async function fetchAndRender(cacheKey, query) {
        // إلغاء أي طلب سابق
        if (currentController) currentController.abort();
        currentController = new AbortController();
        const signal = currentController.signal;

        // عرض مؤشر تحميل أنيق (دون وميض الصفحة)
        showLoadingPlaceholder();

        try {
          const res = await fetch(`/api/phone?phone=${encodeURIComponent(query)}`, { signal });
          if (!res.ok) {
            const txt = await res.text().catch(()=>res.statusText);
            renderError(`❌ خطأ من الخادم: ${res.status} ${txt}`);
            return;
          }
          const data = await res.json();
          if (data.error) {
            renderError(data.error);
            return;
          }

          const results = data.results || [];
          writeCache(cacheKey, results); // خزّن
          renderResults(results, { fromCache: false });
        } catch (err) {
          if (err.name === 'AbortError') return; // تجاهل عند الإلغاء
          renderError('⚠️ حدث خطأ أثناء جلب البيانات.');
          console.error(err);
        } finally {
          currentController = null;
        }
      }

      function showLoadingPlaceholder() {
        // طريقة بسيطة لتحاشي الوميض: حافظ على ارتفاع الشبكة بعناصر هيكلية
        resultDiv.innerHTML = `
          <div class="col-lg-custom">
            <div class="phone-card p-3">
              <div style="width:100%;height:180px;background:linear-gradient(90deg,#eee,#f5f7fb);border-radius:8px"></div>
              <div class="card-body">
                <div style="height:18px;width:60%;background:#eef2fb;border-radius:6px;margin-bottom:8px"></div>
                <div style="height:14px;width:40%;background:#eef2fb;border-radius:6px"></div>
              </div>
            </div>
          </div>`;
      }

      function renderError(msg) {
        resultDiv.innerHTML = `<div class="alert alert-danger w-100 text-center">${msg}</div>`;
      }

      /*******************************
       * عرض النتائج + Lazy Loading
       *******************************/
      // IntersectionObserver لتحميل الصور عند الاقتراب (يعزز loading="lazy")
      const io = new IntersectionObserver((entries) => {
        entries.forEach(ent => {
          if (ent.isIntersecting) {
            const img = ent.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
            io.unobserve(img);
          }
        });
      }, { rootMargin: '200px' });

      function renderResults(results, opts = {}) {
        // إذا لا نتائج
        if (!results || results.length === 0) {
          resultDiv.innerHTML = `<div class="alert alert-warning w-100 text-center">لا توجد نتائج.</div>`;
          return;
        }

        // بناء العنصر بدون innerHTML المتكرر لتقليل الوميض
        const frag = document.createDocumentFragment();
        results.forEach(item => {
          const col = document.createElement('div');
          col.className = 'col-lg-custom';

          const card = document.createElement('div');
          card.className = 'phone-card shadow-sm rounded-3 p-2 h-100';
          card.style.cursor = 'pointer';
          card.dataset.url = item.link || '';
          card.dataset.img = item.img || '';

          // image element (lazy)
          const img = document.createElement('img');
          img.alt = item.title || 'phone';
          img.className = 'result-thumb rounded mb-2';
          img.style.width = '100%';
          img.style.height = '180px';
          img.style.objectFit = 'cover';
          // use data-src (IntersectionObserver) for robust lazy load
          if (item.img) {
            img.dataset.src = item.img;
            img.src = 'data:image/svg+xml;charset=UTF-8,<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg"></svg>'; // placeholder tiny
            io.observe(img);
          } else {
            img.src = '';
            img.style.background = '#f6f8fb';
          }

          const body = document.createElement('div');
          body.className = 'card-body';

          const title = document.createElement('div');
          title.className = 'phone-title';
          title.textContent = item.title || '—';

          const chipBtn = document.createElement('button');
          chipBtn.className = 'btn btn-sm btn-outline-primary chip-btn mb-1';
          chipBtn.type = 'button';
          chipBtn.style.direction = 'ltr';
          chipBtn.title = 'المعالج';
          chipBtn.textContent = item.chipset || 'غير محدد';

          const modelBtn = document.createElement('button');
          modelBtn.className = 'btn btn-sm btn-outline-success chip-btn';
          modelBtn.type = 'button';
          modelBtn.style.direction = 'ltr';
          modelBtn.title = 'الموديل';
          modelBtn.textContent = item.model || '';

          body.appendChild(title);
          body.appendChild(chipBtn);
          if (item.model) body.appendChild(modelBtn);

          card.appendChild(img);
          card.appendChild(body);
          col.appendChild(card);
          frag.appendChild(col);
        });

        // تهيئة DOM مرة واحدة
        resultDiv.innerHTML = '';
        resultDiv.appendChild(frag);

        // تفعيلات: فتح مودال عند الضغط + popover (Bootstrap) on hover
        document.querySelectorAll('.phone-card').forEach(card => {
          card.addEventListener('click', () => {
            const url = card.dataset.url;
            const img = card.dataset.img || '';
            // افتح المودال ثم جلب التفاصيل
            const bs = new bootstrap.Modal(document.getElementById('specsModal'));
            bs.show();
            getDetails(url, img);
          });
        });

        // bootstrap popovers for chipset/model buttons
        const popoverList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        // (we didn't create data-bs attributes here), but keep existing initialization if any
      }

      /*******************************
       * مودال التفاصيل (نفس دالتك المحبوبة)
       *******************************/
      async function getDetails(url, phoneImg) {
        const modalBody = document.getElementById("specsModalBody");
        modalBody.innerHTML = `<div class='alert alert-info text-center'>📱 جاري جلب المواصفات...</div>`;

        try {
          const res = await fetch(`/api/details?url=${encodeURIComponent(url)}`);
          const data = await res.json();

          if (data.error) {
            modalBody.innerHTML = `<div class='alert alert-danger text-center'>❌ ${data.error}</div>`;
            return;
          }

          // تجميع وعرض كما هو في كودك (موجز ومع المحافظة على البنية)
          const sections = {
            "نظرة عامة": ["الإصدار","الماركة","الاسم","النوع","الخامة"],
            السعر: ["السعر","Price","الأسعار"],
            النظام: ["نظام التشغيل","الواجهة","الإصدار"],
            الشاشة: ["الشاشة","النوع","الدقة","السطوع","معدل التحديث"],
            الذاكرة: ["الذاكرة","التخزين","SD","الرام"],
            الأبعاد: ["الأبعاد","الوزن","الحجم"],
            الكاميرا: ["الكاميرا","الخلفية","الأمامية","الفيديو"],
            الصوت: ["الصوت","سماعات","جاك"],
            أخرى: []
          };
          const icons = { "نظرة عامة":"📋","السعر":"💰","النظام":"⚙️","الشاشة":"📱","الذاكرة":"💾","الأبعاد":"📏","الكاميرا":"📸","البطارية":"🔋","الصوت":"🔈","أخرى":"📎" };

          // grouped
          const grouped = {};
          for (const [k,v] of Object.entries(data.specs || {})) {
            let found = false;
            for (const [sec,keys] of Object.entries(sections)) {
              if (keys.some(key => k.includes(key))) { (grouped[sec] ??= []).push({key:k,val:v}); found = true; break; }
            }
            if (!found) (grouped['أخرى'] ??= []).push({key:k,val:v});
          }

          const tabs = Object.keys(sections);
          const navTabs = tabs.map((tab,i)=>`
            <li class="nav-item" role="presentation">
              <button class="nav-link ${i===0?'active':''}" id="tab-${i}" data-bs-toggle="tab" data-bs-target="#content-${i}" type="button">${icons[tab]} ${tab}</button>
            </li>
          `).join('');

          const tabContents = tabs.map((tab,i)=>{
            if (tab==='نظرة عامة') {
              const mainImage = phoneImg || data.img || '';
              // summary cards (screen, cpu, cams, mem, os, batt)
              const screen = data.specs['الشاشة'] || 'غير محددة';
              const cpu = data.specs['المعالج'] || 'غير محدد';
              const cams = (()=>{ const back = data.specs['كاميرا خلفية']||data.specs['الكاميرا الخلفية']||''; const front = data.specs['كاميرا امامية']||data.specs['الكاميرا الأمامية']||''; return (back||front)? `${back}${back&&front? ' / ' : ''}${front}` : 'غير محددة'; })();
              const mem = (()=>{ const sKeys = Object.keys(data.specs||{}).find(k=>/ذاكرة|تخزين|داخلية/i.test(k))||''; const rKeys = Object.keys(data.specs||{}).find(k=>/رام|الرامات|عشوائية/i.test(k))||''; const s = sKeys? data.specs[sKeys]:''; const r = rKeys? data.specs[rKeys]:''; return s && r? `${s} + ${r}` : s||r||'غير محددة'; })();
              const os = data.specs['نظام التشغيل'] || 'غير محدد';
              const batt = (()=>{ const cap = data.specs['سعة البطارية']||data.specs['Battery Capacity']||''; const ch = data.specs['قدرة الشحن']||data.specs['الشحن']||''; if(!cap && !ch) return 'غير محددة'; const capClean = cap.replace(/ملي|مللي|mAh/gi,'').trim().replace(/\.+$/,'') + (cap?' م.أ':''); const chClean = ch.replace(/واط|W/gi,'').trim().replace(/\.+$/,'') + (ch?' واط':''); if(cap && ch) return capClean + ' / ' + chClean; return cap || ch || 'غير محددة'; })();

              return `<div class="tab-pane fade show active" id="content-${i}" role="tabpanel">
                <div class="d-flex flex-column flex-lg-row align-items-center gap-4">
                  <div class="text-center flex-shrink-0">
                    <div class="aps-main-image mb-3">
                      <img fetchpriority="high" class="aps-image-zoom rounded shadow-sm" src="${mainImage}" style="width:100%; max-width:400px;" alt="${data.title||''}">
                    </div>
                    <h4 class="fw-bold mt-2">${data.title||''}</h4>
                  </div>
                  <div class="flex-grow-1 w-100">
                    <div class="row g-3 justify-content-start">
                      ${[
                        {key:'الشاشة', val:screen, icon:'aps-icon-mobile'},
                        {key:'المعالج', val:cpu, icon:'aps-icon-cpu'},
                        {key:'الكاميرات', val:cams, icon:'aps-icon-camera'},
                        {key:'الذاكرة + الرام', val:mem, icon:'aps-icon-hdd'},
                        {key:'نظام التشغيل', val:os, icon:'aps-icon-code'},
                        {key:'البطارية', val:batt, icon:'aps-icon-battery'}
                      ].map(it=>`
                        <div class="col-12 col-md-6">
                          <div class="aps-feature-card">
                            <div class="aps-list-icon ${it.icon}"></div>
                            <div class="aps-feature-info text-center mt-2"><strong>${it.key}</strong><br><span>${it.val}</span></div>
                          </div>
                        </div>`).join('')}
                    </div>
                  </div>
                </div>
              </div>`;
            }

            if (tab==='السعر') {
              const priceVal = grouped['السعر']?.[0]?.val || 'غير متوفر';
              return `<div class="tab-pane fade" id="content-${i}" role="tabpanel"><div class="card border-success text-center shadow-sm p-4 bg-light"><h4 class="text-success fw-bold mb-3">💰 السعر</h4><p class="fs-4 text-success">${priceVal}</p></div></div>`;
            }

            const items = (grouped[tab]||[]).map(it=>`<li class="list-group-item d-flex justify-content-between align-items-center"><strong>${it.key}</strong><span>${it.val}</span></li>`).join('');
            return `<div class="tab-pane fade" id="content-${i}" role="tabpanel"><ul class="list-group list-group-flush">${items || "<li class='list-group-item text-center text-muted'>❌ لا توجد بيانات متاحة.</li>"}</ul></div>`;
          }).join('');

          modalBody.innerHTML = `<ul class="nav nav-tabs justify-content-center flex-wrap" id="specTabs" role="tablist">${navTabs}</ul>
          <div class="tab-content p-3 border border-top-0 rounded-bottom bg-light mt-1">${tabContents}</div>`;

        } catch (err) {
          console.error(err);
          document.getElementById("specsModalBody").innerHTML = `<div class='alert alert-danger text-center'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;
        }
      }

      /*******************************
       * تلميحات مخصصة (tooltip)
       *******************************/
      document.addEventListener('click', (e) => {
        const badge = e.target.closest('.chipset-badge, .model-badge');
        if (!badge) {
          tooltipEl.style.display = 'none';
          return;
        }
        const text = badge.getAttribute('data-tooltip');
        if (!text) return;
        tooltipEl.textContent = text;
        tooltipEl.style.display = 'block';
        tooltipEl.classList.add('show');
        const rect = badge.getBoundingClientRect();
        tooltipEl.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        tooltipEl.style.left = (Math.min(window.innerWidth - 200, rect.left + window.scrollX)) + 'px';
      });

      // اختبر البداية إذا يوجد قيمة مسبقة في الـ input
      if (input.value.trim()) setTimeout(onSearchDebounced, 200);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
