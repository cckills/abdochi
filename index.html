<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>بحث عن الهواتف</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome CDN (إن رغبت باستعمال أيقونات إضافية لاحقًا) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
select.dropdown.select {
  appearance: none; /* إزالة أي تصميم افتراضي */
  -webkit-appearance: none;
  -moz-appearance: none;
  border: 1px solid #92efff;
 /*  padding: 6px 12px; */
  cursor: pointer;
  background-color: #f13ebc;
  color: rgb(123, 238, 128);
  width: 250px;
  border: none;
  font-size: 20px;
  outline: none;
}

/* 🎨 إعدادات الكارت الافتراضي (Bootstrap) */
/* تم تعطيله لتجنّب التعارض مع تصميم vivo Y91C */
 /*
.card {
    --bs-card-spacer-y: 1rem;
    --bs-card-spacer-x: 1rem;
    --bs-card-title-spacer-y: 0.5rem;
    --bs-card-border-width: var(--bs-border-width);
    --bs-card-border-color: var(--bs-border-color-translucent);
    --bs-card-border-radius: var(--bs-border-radius);
    --bs-card-inner-border-radius: calc(var(--bs-border-radius) - (var(--bs-border-width)));
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: var(--bs-card-height);
    color: var(--bs-body-color);
    word-wrap: break-word;
    background-color: #c0ebc229;
    background-clip: border-box;
    border: var(--bs-card-border-width) solid var(--bs-card-border-color);
    border-radius: var(--bs-card-border-radius);
}
*/


/* 🧱 الخط والخلفية العامة */
body {
  background: #f7f8fb;
  font-family: Tahoma, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color: #222;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* 🔍 صندوق البحث */
.search-modal-box {
  max-width: 720px;
  margin: 48px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 6px 22px rgba(13, 110, 253, 0.06);
  padding: 26px;
}

/* 🖊️ حقل البحث */
.search-field {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid #e6e9ee;
  border-radius: 12px;
  font-size: 16px;
  transition: box-shadow .15s, border-color .15s;
}
.search-field:focus {
  outline: none;
  border-color: #bcd7ff;
  box-shadow: 0 6px 18px rgba(13,110,253,0.06);
}

/* 🧩 توزيع نتائج البحث في شبكة */
#result {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap: 25px;
  justify-items: center;
  align-items: start;
  padding: 30px;
  width: 100%;
  box-sizing: border-box;
}

/* 🌟 كارت تصميم vivo Y91C */
.result-item {
  position: relative;
  width: 250px;
  height: 320px;
  box-shadow: 0 35px 80px rgba(0, 0, 0, 0.15);
  background: #fff;
  border-radius: 15px;
  overflow: visible;
  cursor: pointer;
  transition: transform 0.25s ease;
}
.result-item:hover {
  transform: translateY(-5px);
}

/* 🖼️ صورة الهاتف */
.result-item .imgBox {
  position: absolute;
  left: 50%;
  top: -41px;
  transform: translateX(-50%);
  width: 150px;
  height: 174px;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.35);
  overflow: hidden;
}
.result-item .imgBox img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 🧾 محتوى الكارت */
.result-item .content {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

/* 🧱 نصوص الكارت */
.result-item .fw-bold {
  margin-top: 110px;
  font-size: 1.1rem;
  font-weight: 700;
  color: #f30707;
}
.result-item .subtitle {
  font-size: 1rem;
  font-weight: 500;
  color: #555;
  margin-top: 5px;
}
.result-item .modelsTitle {
  font-size: 0.85rem;
  color: #666;
  line-height: 1.4rem;
  margin-top: 10px;
  padding: 0 10px;
}

/* 🎛️ أزرار داخل البطاقة */
.chipset-btn,
.model-btn {
  display: block;
  width: 100%;
  text-align: left;
  direction: ltr;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 13px;
  border-radius: 8px;
}
.chipset-btn { border-color: rgba(13,110,253,0.15); color: #0d6efd; }
.model-btn { border-color: rgba(25,135,84,0.12); color: #198754; }

/* 📱 توزيع الأعمدة */
.col-lg-custom { flex: 0 0 20%; max-width: 20%; }
@media (max-width: 1199px) { .col-lg-custom { flex: 0 0 33.33%; max-width: 33.33%; } }
@media (max-width: 767px) { .col-lg-custom { flex: 0 0 48%; max-width: 48%; } }
@media (max-width: 479px) { .col-lg-custom { flex: 0 0 100%; max-width: 100%; } }

/* 🧮 بطاقات المواصفات (داخل المودال) */
.aps-feature-card {
  background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%);
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(12, 28, 55, 0.04);
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 🎯 أيقونات المودال */
.aps-list-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  margin-bottom: 10px;
  color: #fff;
}
.aps-icon-mobile { background:#0d6efd; }
.aps-icon-mobile::before { content:"📱"; }
.aps-icon-cpu { background:#198754; }
.aps-icon-cpu::before { content:"🧠"; }
.aps-icon-camera { background:#fd7e14; }
.aps-icon-camera::before { content:"📸"; }
.aps-icon-hdd { background:#6f42c1; }
.aps-icon-hdd::before { content:"💾"; }
.aps-icon-code { background:#20c997; }
.aps-icon-code::before { content:"⚙️"; }
.aps-icon-battery { background:#ffc107; color:#000; }
.aps-icon-battery::before { content:"🔋"; }

/* 🗂️ تبويبات المودال */
.nav-tabs { overflow-x:auto; white-space:nowrap; flex-wrap:nowrap !important;}
.nav-tabs .nav-link { font-weight:600; color:#0d6efd; border-radius:12px 12px 0 0; margin:2px; }
.nav-tabs .nav-link.active { background:#0d6efd; color:#fff; }

.tab-content ul li {
  border-bottom: 1px solid #eee;
  padding: 6px 0;
}

/* 🧭 محتوى عام (مكرّر) */
/* تم إيقافه لأنه يتعارض مع .result-item .content */
 /*
.content {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 10px;
  box-sizing: border-box;
}
*/

/* 📱 تحسين العرض على الشاشات الصغيرة */
@media (max-width: 600px) {
  .card {
    width: 200px;
    height: 280px;
  }

  .imgBox {
    width: 120px;
    height: 140px;
    top: -30px;
  }

  .fw-bold {
    font-size: 1rem;
    margin-top: 90px;
  }

  .subtitle {
    font-size: 0.9rem;
  }

  .modelsTitle {
    font-size: 0.75rem;
    line-height: 1.2rem;
  }
}

/* مسافة بسيطة */
.mb-1 {
    margin-bottom: .25rem !important;
}

     /* زر البحث */
    #brand-search-btn {
     width: 100%;
     font-size: 1rem;
     padding: 10px;
    }
    /* زر مسح السجل */
    #clearHistoryBtn {
     width: 100%;
     font-size: 1rem;
     padding: 10px;
    }
   .page-fade.fade-out {
    opacity: 0.35;
   }
   .d-flex {
    display: flex !important
;
    flex-direction: row;
    align-items: flex-end;
   }

</style>

  </head>
  <body>
<div class="container my-4">
  <!-- ✅ بطاقة البحث -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="text-center mb-3 fw-bold text-primary">🔍 بحث عن الهواتف</h5>



      <form id="searchForm" class="text-center">
<p class="message mb-3"> اختر الموديل سيتم جلب الموديل تلقائى  </p>
        <!-- ✅ القائمة ومربع البحث بجانب بعض -->
        <div id="brand-search-box" class="text-center mt-4">
          <div class="d-flex justify-content-center align-items-center flex-wrap gap-2 mb-3">
            <select class="dropdown select form-select"
             style="flex:1; max-width:230px; height:44px; border-radius:8px; font-size:15px;">
              <option value="" selected disabled>اختر علامة تجارية</option>
              <option value="4">Huawei</option>
              <option value="5">Samsung</option>
              <option value="6">Apple</option>
              <!-- باقي الماركات -->
            </select>
<input type="search"  class="form-control text-center" id="phoneInput" name="s"
  placeholder="" required style="flex:1; max-width:230px; height:44px; border-radius:8px; font-size:15px;"/>

<!-- ✅ بحث عن ماركه-->
<input type="text" id="brand-search" placeholder="🔍 ابحث عن ماركة..."
  class="form-control text-center"
  style="flex:1; max-width:230px; height:44px; border-radius:8px; font-size:15px; opacity:0; visibility:hidden; transition:opacity 0.3s ease;">

<!-- ✅ ازالة الفلترة-->
<button id="brand-clear-btn" type="button"
  class="btn btn-secondary px-3 py-2 d-flex align-items-center justify-content-center"
  style="min-width:120px; border-radius:8px; font-size:14px; opacity:0; visibility:hidden; transition:opacity 0.3s ease;">
  🧹 <span class="ms-1">إزالة الفلترة</span>
</button>
</div>

<!-- ✅ فلترة الموديل-->
<div class="d-flex justify-content-center align-items-center gap-3 mt-4">
  <button id="brand-search-btn" type="button"
    class="btn btn-success fw-bold px-4 py-2 d-flex align-items-center justify-content-center"
    style="min-width:170px; border-radius:8px; opacity:0; visibility:hidden; transition:opacity 0.3s ease;">
    🧭 <span class="ms-1">فلترة الموديل</span>
  </button>
</div>

        </div>
      </form>
    </div>
  </div>
</div>

<!-- 
 <button type="submit"
              class="btn btn-primary fw-bold px-4 py-2 d-flex align-items-center justify-content-center"
              style="min-width:150px;">
              🔍 <span class="ms-1">بحث</span>
            </button>-->

<!-- 📦 نتائج البحث داخل بطاقة -->
<div class="container my-4">
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">
      <h5 class="text-center mb-4 text-primary fw-bold">📱 نتائج البحث</h5>
      <!-- ✅ مكان عرض البطاقات -->
 <p id="result-info" style="text-align:center;margin-top:10px;font-weight:bold;color:#222;"></p>

<div id="result" class="row g-3 justify-content-start"></div>
<div id="pagination" class="text-center my-3"></div>
    </div>
  </div>
</div>

   <!-- 🟢 مودال عرض المواصفات -->
    <div class="modal fade" id="specsModal" tabindex="-1" aria-labelledby="specsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg rounded-4">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">تفاصيل الهاتف</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body" id="specsModalBody">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-3 text-muted">جاري التحميل...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function getDetails(url, phoneImg) {
        const modalBody = document.getElementById("specsModalBody");
        modalBody.innerHTML = `<div class='alert alert-info text-center'>📱 جاري جلب المواصفات...</div>`;

        try {
          const res = await fetch(`/api/details?url=${encodeURIComponent(url)}`);
          const data = await res.json();

          if (data.error) {
            modalBody.innerHTML = `<div class='alert alert-danger text-center'>❌ ${data.error}</div>`;
            return;
          }

          const sections = {
            "نظرة عامة": ["الإصدار", "الماركة", "الاسم", "النوع", "الخامة"],
            السعر: ["السعر", "Price", "الأسعار"],
            النظام: ["نظام التشغيل", "الواجهة", "الإصدار"],
            الشاشة: ["الشاشة", "النوع", "الدقة", "السطوع", "معدل التحديث"],
            الذاكرة: ["الذاكرة", "التخزين", "SD", "الرام"],
            الأبعاد: ["الأبعاد", "الوزن", "الحجم"],
            الكاميرا: ["الكاميرا", "الخلفية", "الأمامية", "الفيديو"],
            // "البطارية": ["البطارية","الشحن","السعة"],
            الصوت: ["الصوت", "سماعات", "جاك"],
            أخرى: [],
          };

          const icons = {
            "نظرة عامة": "📋",
            السعر: "💰",
            النظام: "⚙️",
            الشاشة: "📱",
            الذاكرة: "💾",
            الأبعاد: "📏",
            الكاميرا: "📸",
            البطارية: "🔋",
            الصوت: "🔈",
            أخرى: "📎",
          };

          // تجميع البيانات حسب الأقسام
          const grouped = {};
          for (const [key, val] of Object.entries(data.specs)) {
            let found = false;
            for (const [section, keywords] of Object.entries(sections)) {
              if (keywords.some((k) => key.includes(k))) {
                (grouped[section] ??= []).push({ key, val });
                found = true;
                break;
              }
            }
            if (!found) (grouped["أخرى"] ??= []).push({ key, val });
          }

          const tabs = Object.keys(sections);
          const navTabs = tabs
            .map(
              (tab, i) => `
      <li class="nav-item" role="presentation">
        <button class="nav-link ${i === 0 ? "active" : ""}" id="tab-${i}" data-bs-toggle="tab" data-bs-target="#content-${i}" type="button" role="tab">
          ${icons[tab]} ${tab}
        </button>
      </li>`
            )
            .join("");

          const tabContents = tabs
            .map((tab, i) => {
              if (tab === "نظرة عامة") {
                const mainImage =
                  phoneImg || data.img || "https://telfonak.com/wp-content/uploads/2023/12/huawei-y9-prime-2019.webp";

                return `
<div class="tab-pane fade show active" id="content-${i}" role="tabpanel">
  <div class="d-flex flex-column flex-lg-row align-items-center gap-4">

    <!-- الصورة -->
    <div class="text-center flex-shrink-0">
      <div class="aps-main-image mb-3">
        <img fetchpriority="high" class="aps-image-zoom rounded shadow-sm" 
             src="${mainImage}" 
             style="width:100%; max-width:400px;" 
             alt="${data.title}">
        <div class="aps-img-loader"><span class="aps-loader"></span></div>
      </div>
      <h4 class="fw-bold mt-2">${data.title}</h4>
    </div>

    <!-- البطاقات -->
    <div class="flex-grow-1 w-100">
      <div class="row g-3 justify-content-start">
        ${[
          {
            key: "الشاشة",
            val: (() => {
              const screenRaw = data.specs["الشاشة"] || "غير محددة";

              if (screenRaw === "غير محددة") return screenRaw;

              // 🔍 استخراج نوع الشاشة
              const typeMatch = screenRaw.match(/(IPS\s*LCD|AMOLED|OLED|Super\s*AMOLED|LTPO|PLS|TFT)/i);
              const type = typeMatch ? typeMatch[0].replace(/\s+/g, " ").trim().toUpperCase() : "";

              // 🔍 استخراج الحجم بالبوصة
              const sizeMatch = screenRaw.match(/(\d+(\.\d+)?)\s*(بوصة|بوصه|inch|")/i);
              const size = sizeMatch ? `${sizeMatch[1]} بوصة` : "";

              // 🔍 استخراج الدقة
              let res = "";
              if (/FHD/i.test(screenRaw)) res = "بدقة FHD+";
              else if (/HD\+/i.test(screenRaw)) res = "بدقة HD+";
              else if (/QHD/i.test(screenRaw)) res = "بدقة QHD+";
              else if (/UHD|4K/i.test(screenRaw)) res = "بدقة 4K";
              else {
                const resMatch = screenRaw.match(/(\d{3,4})\s*[x×]\s*(\d{3,4})/i);
                if (resMatch) {
                  const width = Math.max(resMatch[1], resMatch[2]);
                  res = width >= 2000 ? "بدقة FHD+" : "بدقة HD+";
                }
              }

              // 📱 تركيب النتيجة النهائية
              if (type || size || res) {
                return `${type}${type && size ? " بحجم " : ""}${size}${(type || size) && res ? " " : ""}${res}`.trim();
              } else {
                return screenRaw;
              }
            })(),
            icon: "aps-icon-mobile",
          },

          { key: "المعالج", val: data.specs["المعالج"] || "غير محدد", icon: "aps-icon-cpu" },
          {
            key: "الكاميرات",
            val: (() => {
              const backRaw = data.specs["كاميرا خلفية"] || data.specs["الكاميرا الخلفية"] || "";
              const frontRaw = data.specs["كاميرا امامية"] || data.specs["الكاميرا الأمامية"] || "";

              const extractMP = (text) => {
                const matches = text.match(/(\d+)\s*(?:ميجا|م\.ب)/g); // فقط الأرقام المتبوعة بميجا أو م.ب
                if (!matches) return "غير محددة";
                const clean = matches.map((m) => m.replace(/\D/g, "")); // نحذف أي حروف ونحتفظ بالأرقام فقط
                return clean.join("+") + " م.ب";
              };

              const back = extractMP(backRaw);
              const front = extractMP(frontRaw);

              if (back !== "غير محددة" && front !== "غير محددة") {
                return `خلفية ${back} / أمامية ${front}`;
              } else if (back !== "غير محددة") {
                return `خلفية ${back}`;
              } else if (front !== "غير محددة") {
                return `أمامية ${front}`;
              } else {
                return "غير محددة";
              }
            })(),
            icon: "aps-icon-camera",
          },

          {
            key: "الذاكرة + الرام",
            val: (() => {
              // 🔍 البحث عن المفاتيح المحتملة للذاكرة والرام
              const storageKey = Object.keys(data.specs).find((k) => /ذاكرة|تخزين|داخلية/i.test(k)) || "";
              const ramKey = Object.keys(data.specs).find((k) => /رام|الرامات|عشوائية/i.test(k)) || "";

              const storage = storageKey ? data.specs[storageKey].replace(/\s*\.\s*$/, "") : "";
              const ram = ramKey ? data.specs[ramKey].replace(/\s*\.\s*$/, "") : "";

              if (storage && ram) return `${storage} + ${ram}`;
              else if (storage) return storage;
              else if (ram) return ram;
              else return "غير محددة";
            })(),
            icon: "aps-icon-hdd",
          },

          { key: "نظام التشغيل", val: data.specs["نظام التشغيل"] || "غير محدد", icon: "aps-icon-code" },
          {
            key: "البطارية",
            val: (() => {
              // 🔋 جلب القيم مباشرة من الموقع
              const capacity = data.specs["سعة البطارية"] || data.specs["Battery Capacity"] || "";
              const charging = data.specs["قدرة الشحن"] || data.specs["الشحن"] || "";

              if (!capacity && !charging) return "غير محددة";

              // ⚙️ تنظيف النصوص قليلاً
              const capClean =
                capacity
                  .replace(/ملي|مللي|mAh/gi, "")
                  .trim()
                  .replace(/\.+$/, "") + " م.أ";
              const chargeClean = charging.replace(/واط|W/gi, "").trim().replace(/\.+$/, "") + " واط";

              // 🧩 دمج الناتج بشكل منسق
              if (capacity && charging) return `${capClean} / ${chargeClean}`;
              if (capacity) return capClean;
              if (charging) return chargeClean;
              return "غير محددة";
            })(),
            icon: "aps-icon-battery",
          },
        ]
          .map(
            (item) => `
          <div class="col-12 col-md-6">
            <div class="aps-feature-card">
              <div class="aps-list-icon ${item.icon}"></div>
              <div class="aps-feature-info text-center mt-2">
                <strong>${item.key}</strong><br>
                <span>${item.val}</span>
              </div>
            </div>
          </div>`
          )
          .join("")}
      </div>
    </div>

  </div>
</div>`;
              }

              if (tab === "السعر") {
                const priceVal = grouped["السعر"]?.[0]?.val || "غير متوفر";
                return `<div class="tab-pane fade" id="content-${i}" role="tabpanel">
          <div class="card border-success text-center shadow-sm p-4 bg-light">
            <h4 class="text-success fw-bold mb-3">💰 السعر</h4>
            <p class="fs-4 text-success">${priceVal}</p>
          </div>
        </div>`;
              }

              const sectionItems = grouped[tab]?.length
                ? grouped[tab]
                    .map(
                      (item) =>
                        `<li class="list-group-item d-flex justify-content-between align-items-center"><strong>${item.key}</strong><span>${item.val}</span></li>`
                    )
                    .join("")
                : "<li class='list-group-item text-center text-muted'>❌ لا توجد بيانات متاحة.</li>";

              return `<div class="tab-pane fade" id="content-${i}" role="tabpanel"><ul class="list-group list-group-flush">${sectionItems}</ul></div>`;
            })
            .join("");

          modalBody.innerHTML = `
      <ul class="nav nav-tabs justify-content-center flex-wrap" id="specTabs" role="tablist">${navTabs}</ul>
      <div class="tab-content p-3 border border-top-0 rounded-bottom bg-light mt-1" id="specTabsContent">${tabContents}</div>
    `;

          new bootstrap.Modal(document.getElementById("specsModal")).show();
        } catch (err) {
          console.error(err);
          modalBody.innerHTML = `<div class='alert alert-danger text-center'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;
        }
      }
    </script>

    <script>
      const form = document.getElementById("searchForm");
      const input = document.getElementById("phoneInput");
      const resultDiv = document.getElementById("result");
    
   form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const phone = input.value.trim();
  if (!phone) return;
  // 🧹 تنظيف النتائج القديمة قبل أي بحث جديد
  document.getElementById("result-info").textContent = "";
  document.getElementById("pagination").innerHTML = "";
  resultDiv.innerHTML = "";

  // 🎨 عرض رسالة أنيقة في منتصف المنطقة أثناء البحث
  resultDiv.innerHTML = `
    <div class="d-flex flex-column justify-content-center align-items-center py-5" style="min-height: 300px;">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">جاري البحث...</span>
      </div>
      <div class="text-center text-secondary fs-5">
        🔍 جاري البحث عن <strong>${phone}</strong>...
      </div>
    </div>
  `;

        try {
          const res = await fetch(`/api/${encodeURIComponent(phone)}`);
          const data = await res.json();
          console.log("📄 Pagination Info:", data.total, data.totalPages, data.currentPage);

// ✅ عرض عدد النتائج والصفحة
const totalResults = data.results.length;
const totalPages = Math.ceil(totalResults / 20);
const currentPage = 1;

document.getElementById("result-info").textContent =
  `عدد النتائج: ${totalResults} | الصفحة ${currentPage} من ${totalPages}`;

          if (data.error) {
            resultDiv.innerHTML = `<div class='alert alert-danger'>❌ ${data.error}</div>`;
            return;
          }
if (!data.mode || data.mode === "list") {
  const itemsPerPage = 20;
  let currentPage = 1;

  function renderPage(page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = data.results.slice(start, end);

    let cards = "<div class='row justify-content-start g-3'>";
    for (const item of pageItems) {
      const chipsetText = Array.isArray(item.chipset) ? item.chipset.join(", ") : item.chipset || "غير محدد";
      const modelText = Array.isArray(item.model) ? item.model.join(", ") : item.model || "";

      cards += `
        <div class="col-lg-custom d-flex justify-content-center">
          <div class="card result-item"
               data-url="${item.link}"
               data-img="${item.img || ""}"
               style="position:relative;width:250px;height:320px;box-shadow:0 35px 80px rgba(0,0,0,0.15);background:#fff;border-radius:15px;overflow:visible;cursor:pointer;transition:transform .2s ease;">
            
            <div class="imgBox"
                 style="position:absolute;left:50%;top:-41px;transform:translateX(-50%);width:150px;height:174px;background:#fff;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,0.35);overflow:hidden;">
              <img src="${item.img || 'https://via.placeholder.com/150'}" 
                   alt="${item.title}" 
                   style="width:100%;height:100%;object-fit:cover;">
            </div>
            
            <div class="content"
                 style="position:absolute;bottom:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;">
              <div class="fw-bold mb-1"
                   style="margin-top:110px;font-size:1.2rem;font-weight:700;color:#222;">
                ${item.title}
              </div>
              <div class="subtitle"
                   style="font-size:1rem;font-weight:500;color:#555;margin-top:5px;">
                ${item.chipset || 'غير محدد'}
              </div>
              <div class="modelsTitle"
                   style="font-size:0.85rem;color:#666;line-height:1.4rem;margin-top:10px;padding:0 10px;">
                ${Array.isArray(item.model) ? item.model.join(', ') : (item.model || '')}
              </div>
            </div>
          </div>
        </div>`;
    }
    cards += "</div>";
    resultDiv.innerHTML = cards;

    // تفعيل الضغط على الكروت
    document.querySelectorAll(".result-item").forEach(card => {
      card.addEventListener("click", () => {
        const phoneUrl = card.getAttribute("data-url");
        const phoneImg = card.getAttribute("data-img") || "";
        new bootstrap.Modal(document.getElementById("specsModal")).show();
        getDetails(phoneUrl, phoneImg);
      });
    });
  }


  function renderPagination() {
    const totalPages = Math.ceil(data.results.length / itemsPerPage);
    const pagination = document.getElementById("pagination");
    if (totalPages <= 1) {
      pagination.innerHTML = "";
      return;
    }

    let html = `<nav><ul class="pagination justify-content-center flex-wrap">`;

    html += `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
               <a class="page-link" href="#" data-page="${currentPage - 1}">السابق</a>
             </li>`;

    for (let i = 1; i <= totalPages; i++) {
      html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                 <a class="page-link" href="#" data-page="${i}">${i}</a>
               </li>`;
    }

    html += `<li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
               <a class="page-link" href="#" data-page="${currentPage + 1}">التالي</a>
             </li>`;

    html += `</ul></nav>`;
    pagination.innerHTML = html;

    pagination.querySelectorAll("a.page-link").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const page = parseInt(e.target.getAttribute("data-page"));
if (page >= 1 && page <= totalPages) {
  currentPage = page;
  renderPage(currentPage);
  renderPagination();

  // ✅ تحديث النص عند التبديل بين الصفحات
  document.getElementById("result-info").textContent =
    `عدد النتائج: ${data.results.length} | الصفحة ${currentPage} من ${totalPages}`;

  window.scrollTo({ top: 0, behavior: "smooth" });
}

      });
    });
  }

  // أول عرض
  renderPage(currentPage);
  renderPagination();






            // ✅ تفعيل popover من Bootstrap بعد إدخال الكروت
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(
              (el) =>
                new bootstrap.Popover(el, {
                  placement: "top",
                  container: "body",
                  html: true,
                })
            );

            // سكربت تفعيل التلميحات
            document.querySelectorAll(".chipset-badge, .model-badge").forEach((badge) => {
              const tooltip = badge.querySelector(".tooltip");
              badge.addEventListener("mouseenter", () => {
                tooltip.style.opacity = "1";
                tooltip.style.pointerEvents = "auto";
              });
              badge.addEventListener("mouseleave", () => {
                tooltip.style.opacity = "0";
                tooltip.style.pointerEvents = "none";
              });
            });
   } else if (data.mode === "details") {
  // عرض مواصفات الهاتف مباشرة
  let specsHtml = "";
  for (const [key, val] of Object.entries(data.specs)) {
    specsHtml += `<li><strong>${key}:</strong> ${val}</li>`;
  }

  resultDiv.innerHTML = `
    <div class="card p-3 shadow-sm">
      <h5 class="text-center mb-3 fw-bold text-primary">${data.title}</h5>
      <img src="${data.img}" class="rounded mx-auto d-block mb-3" style="max-width:260px;">
      <ul class="list-group list-group-flush">${specsHtml}</ul>
      <button class="btn btn-primary mt-3 w-100" onclick="getDetails('${data.link}', '${data.img}')">عرض التفاصيل الكاملة</button>
    </div>
  `;


                        }
                       } catch (err) {
                        resultDiv.innerHTML = `<div class='alert alert-danger'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;
                            }
                           });
     // 🧠 التلميحات (Tooltip المخصص)
      document.addEventListener("click", (e) => {
        const badge = e.target.closest(".chipset-badge, .model-badge");
        if (!badge) return;

        const tooltipText = badge.getAttribute("data-tooltip");
        if (!tooltipText) return;

        // إزالة أي تلميحات مفتوحة مسبقًا
        document.querySelectorAll(".tooltip-popup").forEach((el) => el.remove());

        // إنشاء التلميح
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip-popup";
        tooltip.textContent = tooltipText;
        document.body.appendChild(tooltip);

        // تحديد موقع التلميح
        const rect = badge.getBoundingClientRect();
        tooltip.style.position = "absolute";
        tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
        tooltip.style.left = `${rect.left + window.scrollX}px`;
        tooltip.style.padding = "8px 12px";
        tooltip.style.background = "#333";
        tooltip.style.color = "#fff";
        tooltip.style.borderRadius = "6px";
        tooltip.style.fontSize = "13px";
        tooltip.style.zIndex = "9999";
        tooltip.style.transition = "opacity .25s";
        tooltip.style.opacity = "1";

        // إغلاق التلميح عند الضغط خارج العنصر
        const closeTooltip = (ev) => {
          if (!tooltip.contains(ev.target) && ev.target !== badge) {
            tooltip.remove();
            document.removeEventListener("click", closeTooltip);
          }
        };
        document.addEventListener("click", closeTooltip);
      });


// 🧩 متغير لتخزين جميع النتائج الأصلية
let allResults = [];
// عند البحث الرئيسي
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const phone = input.value.trim();
  if (!phone) return;

  resultDiv.innerHTML = `<div class="text-center p-5">🔍 جاري البحث...</div>`;

  try {
    const res = await fetch(`/api/${encodeURIComponent(phone)}`);
    const data = await res.json();

    if (data.error) {
      resultDiv.innerHTML = `<div class='alert alert-danger'>❌ ${data.error}</div>`;
      return;
    }

    allResults = data.results;
    renderFilteredResults(allResults, allResults.length);
  } catch (err) {
    resultDiv.innerHTML = `<div class='alert alert-danger'>⚠️ خطأ في الاتصال.</div>`;
  }
});


// ✅ دالة إعادة الرسم + التظليل
function renderFilteredResults(results, totalMatched = results.length, highlightQuery = "") {
  const resultInfo = document.getElementById("result-info");
  const result = document.getElementById("result");
  const pagination = document.getElementById("pagination");

  result.innerHTML = "";
  pagination.innerHTML = "";

  if (results.length === 0) {
    result.innerHTML = `<div class="text-center text-muted p-4">❌ لا توجد نتائج مطابقة.</div>`;
    resultInfo.textContent = "عدد النتائج: 0";
    return;
  }

  const totalAll = allResults.length;
  const itemsPerPage = 20;
  let currentPage = 1;
  const totalPages = Math.ceil(results.length / itemsPerPage);

  // ✅ دالة لتظليل النصوص المتطابقة
  function highlight(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, "gi");
    return text.replace(regex, `<mark style="background-color:#cce5ff;">$1</mark>`);
  }

  function renderPage(page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageItems = results.slice(start, end);

    let html = "<div class='row justify-content-start g-3'>";
    for (const item of pageItems) {
      const title = highlight(item.title || "", highlightQuery);
      const chipset = highlight(item.chipset || "غير محدد", highlightQuery);
      const model = highlight(
        Array.isArray(item.model) ? item.model.join(", ") : (item.model || ""),
        highlightQuery
      );

      html += `
        <div class="col-lg-custom d-flex justify-content-center">
          <div class="card result-item" data-url="${item.link}" data-img="${item.img || ''}"
               style="position:relative;width:250px;height:320px;box-shadow:0 35px 80px rgba(0,0,0,0.15);background:#fff;border-radius:15px;overflow:visible;cursor:pointer;">
            
            <div class="imgBox" style="position:absolute;left:50%;top:-41px;transform:translateX(-50%);width:150px;height:174px;background:#fff;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,0.35);overflow:hidden;">
              <img src="${item.img || 'https://via.placeholder.com/150'}" alt="${item.title}" style="width:100%;height:100%;object-fit:cover;">
            </div>

            <div class="content text-center" style="position:absolute;bottom:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
              <div class="fw-bold" style="margin-top:110px;font-size:1.2rem;color:#222;">${title}</div>
              <div class="subtitle" style="font-size:1rem;color:#555;margin-top:5px;">${chipset}</div>
              <div class="modelsTitle" style="font-size:0.85rem;color:#666;margin-top:10px;">${model}</div>
            </div>
          </div>
        </div>`;
    }
    html += "</div>";
    result.innerHTML = html;

    // عند الضغط على الكارت
    document.querySelectorAll(".result-item").forEach(card => {
      card.addEventListener("click", () => {
        getDetails(card.dataset.url, card.dataset.img);
      });
    });

   // بعد تحديث النص في resultInfo:
resultInfo.textContent = `عدد النتائج: ${totalAll} | الصفحة ${page} من ${totalPages} | عرض متطابق: ${totalMatched}`;

// إظهار العناصر فقط عند وجود عرض متطابق
if (totalMatched > 0) {
  document.getElementById("brand-search").style.opacity = "1";
  document.getElementById("brand-search").style.visibility = "visible";

  document.getElementById("brand-clear-btn").style.opacity = "1";
  document.getElementById("brand-clear-btn").style.visibility = "visible";

  document.getElementById("brand-search-btn").style.opacity = "1";
  document.getElementById("brand-search-btn").style.visibility = "visible";
  }  }

  function renderPagination() {
    if (totalPages <= 1) return;

    let html = `<nav><ul class="pagination justify-content-center flex-wrap">`;
    html += `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
               <a class="page-link" href="#" data-page="${currentPage - 1}">السابق</a></li>`;

    for (let i = 1; i <= totalPages; i++) {
      html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                 <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }

    html += `<li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
               <a class="page-link" href="#" data-page="${currentPage + 1}">التالي</a></li>`;
    html += "</ul></nav>";

    pagination.innerHTML = html;

    pagination.querySelectorAll("a.page-link").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const p = parseInt(e.target.dataset.page);
        if (p >= 1 && p <= totalPages) {
          currentPage = p;
          renderPage(currentPage);
          renderPagination();
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      });
    });
  }

  renderPage(currentPage);
  renderPagination();
}

// ربط قائمة الماركات (<select>) بمربع البحث
const brandDropdown = document.querySelector(".dropdown.select");
brandDropdown.addEventListener("change", () => {
  const selectedBrand = brandDropdown.options[brandDropdown.selectedIndex].text;
phoneInput.value = selectedBrand; // الآن سيظهر الاسم بدل الرقم

  phoneInput.value = selectedBrand; // وضع الاسم في مربع البحث
  phoneInput.focus();
        // (اختياري) إذا كنت تريد تنفيذ البحث فور الاختيار:
    document.getElementById("searchForm").requestSubmit();
});

// منع زر Enter في حقلي البحث الرئيسى والبحث عن الماركة
document.addEventListener("keydown", function (e) {
  if (
    (e.target.id === "phoneInput" || e.target.id === "brand-search") &&
    e.key === "Enter"
  ) {
    e.preventDefault(); // يمنع الإرسال أو إعادة التحميل
    return false;
  }
});
  // 🚫 منع زر Enter من إعادة تحميل الصفحة
  ["brand-search"].forEach(id => {
    document.getElementById(id).addEventListener("keydown", function(e) {
      if (e.key === "Enter") e.preventDefault();
    });
  });

 
  // هذه الدالة تُستخدم عادة بعد جلب البيانات من السيرفر
  function setResults(results) {
    allResults = results;
  }

  // 🟦 الدالة التي تنفّذ الفلترة فعلياً
  function filterResults(query) {
    if (!Array.isArray(allResults) || allResults.length === 0) return;

    const q = query.trim().toLowerCase();

    const filtered = allResults.filter(item => {
      const title = (item.title || "").toLowerCase();
      const chipset = (item.chipset || "").toLowerCase();
      const models = Array.isArray(item.model)
        ? item.model.join(", ").toLowerCase()
        : (item.model || "").toLowerCase();
      return (
        q === "" ||
        title.includes(q) ||
        chipset.includes(q) ||
        models.includes(q)
      );
    });

    renderFilteredResults(filtered, filtered.length, q);
  }
// 🟢 فلترة فورية عند الكتابة (بدون تأخير ملحوظ)
let debounceTimer;
document.getElementById("brand-search").addEventListener("input", (e) => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const query = e.target.value.trim();
    filterResults(query);
  }, 50); // يمكنك جعلها 100 لتصبح فورية تقريبًا
});

  // 🟢 فلترة فورية عند الكتابة (بدون تأخير)
 // document.getElementById("brand-search").addEventListener("input", function() {
 //   filterResults(this.value);
 // });

  // 🟢 عند الضغط على زر "بحث"
  document.getElementById("brand-search-btn").addEventListener("click", function() {
    const query = document.getElementById("brand-search").value;
    filterResults(query);
  });

  // 🟠 زر "إزالة الفلترة"
  document.getElementById("brand-clear-btn").addEventListener("click", function() {
    document.getElementById("brand-search").value = "";
    filterResults("");
  });


  
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
.modal.fade .modal-dialog {
  transition: transform .25s ease-out;
  transform: translateY(-12px);
}
.modal.show .modal-dialog {
  transform: translateY(0);
}
</style>

  </body>
</html>

