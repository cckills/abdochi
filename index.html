<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>بحث عن الهواتف</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      body { background: #f7f8fb; font-family: Tahoma, "Segoe UI", Roboto, Arial, sans-serif; color: #222; }
      .search-field { width: 100%; padding: 12px 14px; border-radius: 12px; font-size: 16px; border: 2px solid #e6e9ee; transition: box-shadow .15s, border-color .15s; }
      .search-field:focus { outline:none; border-color:#bcd7ff; box-shadow:0 6px 18px rgba(13,110,253,0.06);}
      .results-grid { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; }
      .result-item { background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.08); transition: transform .2s, box-shadow .2s; overflow:hidden; flex:0 0 23%; display:flex; flex-direction:column; cursor:pointer; }
      .result-item:hover { transform:translateY(-4px); box-shadow:0 12px 24px rgba(0,0,0,0.12);}
      .result-thumb { width:100%; height:180px; object-fit:cover; display:block; border-radius:8px; }
      .result-item > div { padding:8px 10px; display:flex; flex-direction:column; gap:4px; }
      .result-item .fw-bold { font-size:15px; color:#0d6efd; text-align:center; }
      .result-item button { font-size:13px; border-radius:8px; padding:4px 6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; margin-top:2px;}
      .result-item button.btn-outline-primary { border-color: rgba(13,110,253,0.15); color:#0d6efd; }
      .result-item button.btn-outline-success { border-color: rgba(25,135,84,0.15); color:#198754; }
      html[dir="rtl"] .result-item button { text-align:right; }
      @media(max-width:1199.98px){.result-item{flex:0 0 30%;}}
      @media(max-width:767.98px){.result-item{flex:0 0 48%;}}
      @media(max-width:479.98px){.result-item{flex:0 0 100%;}}

      /* مودال المواصفات */
      .aps-feature-card { background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%); padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px rgba(12,28,55,0.04); display:flex; flex-direction:column; align-items:center; }
      .aps-list-icon { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; color:#fff; margin-bottom:10px; }
      .aps-icon-mobile { background-color: #0d6efd; }
      .aps-icon-mobile::before { content:"📱"; }
      .aps-icon-cpu { background-color:#198754; }
      .aps-icon-cpu::before { content:"🧠"; }
      .aps-icon-camera { background-color:#fd7e14; }
      .aps-icon-camera::before { content:"📸"; }
      .aps-icon-hdd { background-color:#6f42c1; }
      .aps-icon-hdd::before { content:"💾"; }
      .aps-icon-code { background-color:#20c997; }
      .aps-icon-code::before { content:"⚙️"; }
      .aps-icon-battery { background-color:#ffc107; color:#000; }
      .aps-icon-battery::before { content:"🔋"; }
      .aps-feature-info strong { color:#111; font-size:15px; }
      .aps-feature-info span { font-size:14px; color:#333; text-align:center; }
      .nav-tabs { overflow-x:auto; white-space:nowrap; flex-wrap:nowrap!important; }
      .nav-tabs .nav-link { font-weight:600; color:#0d6efd; border-radius:12px 12px 0 0; margin:2px; }
      .nav-tabs .nav-link.active { background-color:#0d6efd; color:#fff; }
      .tab-content ul li { border-bottom:1px solid #eee; padding:6px 0; }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <div class="card mb-4 shadow-sm">
        <div class="card-body text-center">
          <h5 class="fw-bold text-primary mb-3">🔍 بحث عن الهواتف</h5>
          <form id="searchForm">
            <input type="search" class="search-field mb-3 text-center" id="phoneInput" placeholder="ابحث عن اسم الهاتف..." required />
            <button type="submit" class="btn btn-primary w-100 fw-bold py-2">بحث</button>
          </form>
        </div>
      </div>
    </div>

    <div class="container my-4">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <h5 class="text-center fw-bold text-primary mb-4">📱 نتائج البحث</h5>
          <div id="result" class="results-grid"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="specsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 shadow-lg">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">تفاصيل الهاتف</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="specsModalBody">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-3 text-muted">جاري التحميل...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function getDetails(url, phoneImg) {
        const modalBody = document.getElementById("specsModalBody");
        modalBody.innerHTML = `<div class='alert alert-info text-center'>📱 جاري جلب المواصفات...</div>`;
        try {
          const res = await fetch(`/api/details?url=${encodeURIComponent(url)}`);
          const data = await res.json();
          if(data.error){ modalBody.innerHTML = `<div class='alert alert-danger text-center'>❌ ${data.error}</div>`; return; }

          const specs = data.specs || {};
          const sections = [
            { key:"الشاشة", icon:"aps-icon-mobile" },
            { key:"المعالج", icon:"aps-icon-cpu" },
            { key:"الكاميرات", icon:"aps-icon-camera" },
            { key:"الذاكرة + الرام", icon:"aps-icon-hdd" },
            { key:"نظام التشغيل", icon:"aps-icon-code" },
            { key:"البطارية", icon:"aps-icon-battery" }
          ];

          const cardsHtml = sections.map(section=>{
            let val="";
            switch(section.key){
              case "الشاشة":
                val = specs["الشاشة"]||"غير محددة";
                break;
              case "المعالج":
                val = specs["المعالج"]||"غير محدد";
                break;
              case "الكاميرات":
                const back = specs["كاميرا خلفية"]||specs["الكاميرا الخلفية"]||"";
                const front = specs["كاميرا امامية"]||specs["الكاميرا الأمامية"]||"";
                val = (back?`خلفية ${back}`:"") + (front?` / أمامية ${front}`:"") || "غير محددة";
                break;
              case "الذاكرة + الرام":
                const storage = specs["الذاكرة"]||specs["التخزين"]||"";
                const ram = specs["RAM"]||specs["الرام"]||"";
                val = [storage,ram].filter(Boolean).join(" + ") || "غير محددة";
                break;
              case "نظام التشغيل":
                val = specs["نظام التشغيل"]||"غير محدد";
                break;
              case "البطارية":
                const capacity = specs["سعة البطارية"]||"";
                const charge = specs["الشحن"]||"";
                val = [capacity,charge].filter(Boolean).join(" / ") || "غير محددة";
                break;
            }
            return `<div class="col-12 col-md-6">
              <div class="aps-feature-card">
                <div class="aps-list-icon ${section.icon}"></div>
                <div class="aps-feature-info text-center mt-2">
                  <strong>${section.key}</strong><br>
                  <span>${val}</span>
                </div>
              </div>
            </div>`;
          }).join("");

          modalBody.innerHTML = `
            <div class="d-flex flex-column flex-lg-row gap-4 align-items-center">
              <div class="text-center flex-shrink-0">
                <img src="${phoneImg||data.img||'https://via.placeholder.com/400x300'}" class="rounded shadow-sm mb-2" style="max-width:400px;width:100%;">
                <h4 class="fw-bold mt-2">${data.title}</h4>
              </div>
              <div class="flex-grow-1 w-100">
                <div class="row g-3 justify-content-start">${cardsHtml}</div>
              </div>
            </div>
          `;
          new bootstrap.Modal(document.getElementById("specsModal")).show();
        } catch(err){ console.error(err); modalBody.innerHTML = `<div class='alert alert-danger text-center'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`;}
      }

      const form = document.getElementById("searchForm");
      const input = document.getElementById("phoneInput");
      const resultDiv = document.getElementById("result");

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const phone = input.value.trim();
        if(!phone) return;
        resultDiv.innerHTML = `<div class='alert alert-info w-100 text-center'>🔍 جاري البحث عن "${phone}"...</div>`;
        try{
          const res = await fetch(`/api/${encodeURIComponent(phone)}`);
          const data = await res.json();
          if(data.error){ resultDiv.innerHTML = `<div class='alert alert-danger w-100 text-center'>❌ ${data.error}</div>`; return; }
          if(!data.results||data.results.length===0){ resultDiv.innerHTML = `<div class='alert alert-warning w-100 text-center'>⚠️ لا توجد نتائج</div>`; return; }

          let cardsHtml = '';
          data.results.forEach(item=>{
            const chipsetText = Array.isArray(item.chipset)?item.chipset.join(", "):item.chipset||"غير محدد";
            const modelText = Array.isArray(item.model)?item.model.join(", "):item.model||"";
            cardsHtml += `
              <div class="result-item" data-url="${item.link}" data-img="${item.img||''}">
                <img src="${item.img||'https://via.placeholder.com/300x180'}" class="result-thumb" alt="${item.title}">
                <div>
                  <div class="fw-bold">${item.title}</div>
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="popover" data-bs-trigger="hover focus" title="⚙️ نوع المعالج" data-bs-content="${item.chipsetTooltip||chipsetText}">${chipsetText}</button>
                  ${modelText? `<button class="btn btn-sm btn-outline-success" data-bs-toggle="popover" data-bs-trigger="hover focus" title="📱 الموديل والطراز" data-bs-content="${item.modelTooltip||modelText}">${modelText}</button>` : ''}
                </div>
              </div>`;
          });
          resultDiv.innerHTML = cardsHtml;

          const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
          popoverTriggerList.map(el=>new bootstrap.Popover(el,{html:true,container:'body'}));

          document.querySelectorAll(".result-item").forEach(card=>{
            card.addEventListener("click",()=>getDetails(card.dataset.url, card.dataset.img));
          });

        } catch(err){ console.error(err); resultDiv.innerHTML = `<div class='alert alert-danger text-center'>⚠️ حدث خطأ أثناء جلب البيانات.</div>`; }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
